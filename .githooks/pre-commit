#!/bin/sh
# caveat: this script assumes all modifications to a file were staged in the commit
# beware if you are in the habit of committing only partial modifications to a file:
# THIS HOOK WILL ADD ALL MODIFICATIONS TO A FILE TO THE COMMIT IF ANY FILE WAS CHANGED BY LINTING

# Source common hook utilities
. "$(dirname "$0")/common.sh"

# Initialize branch name
init_branch_name

print_header "Checking \"$BRANCH_NAME\"..."

if should_skip_hook; then
	print_success "No checks necessary on \"$BRANCH_NAME\", pushing now... ðŸŽ‰"
	exit 0
fi

# Identify staged Ruby-related files (including Gemfile/Rakefile) to lint before commit.
RUBY_FILES="$(git diff --diff-filter=d --name-only --cached | grep -E '(Gemfile|Rakefile|\.(rb|rake|ru))$')"
PRE_STATUS="$(git status | wc -l)"

# Initialise exit code variables to track success (0 = success)
RUBOCOP_EXIT_CODE=0
WORK_DONE=0

if [ -z "$RUBY_FILES" ]; then
  print_error "There are currently no updated files in \"$BRANCH_NAME\". ðŸ¤¨"
else
  print_warning "Running Rubocop..."
  # Convert space-separated file list into positional parameters for safe argument passing
  set -- $RUBY_FILES
  # Execute RuboCop with auto-fix enabled on the staged files that have been set
  bundle exec rubocop -a --force-exclusion -- "$@"
  # Capture the exit code from RuboCop command (0 = success, non-zero = errors)
  RUBOCOP_EXIT_CODE=$?
  # Flag that linting ran so we can report result and re-add files if needed.
  WORK_DONE=1
fi

POST_STATUS="$(git status | wc -l)"

if [ ! $RUBOCOP_EXIT_CODE -eq 0 ]; then
  git reset HEAD
  print_error "Linting has uncorrectable errors; please fix and restage your commit. ðŸ˜–"
  exit 1
fi

if [ "$PRE_STATUS" != "$POST_STATUS" ]; then
  git add "$RUBY_FILES"
fi

if [ ! $WORK_DONE -eq 0 ]; then
  print_success "Linting completed successfully! ðŸŽ‰"
fi

exit 0
